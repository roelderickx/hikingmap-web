function add_tracks(e){for(var t=0;t<get_amount_tracks();t++){var o=new OpenLayers.Layer.Vector("track_"+t);o.style={strokeColor:track_color,strokeWidth:track_width,strokeOpacity:track_opacity},o.projection=new OpenLayers.Projection("EPSG:4326");var n=new OpenLayers.Format.EncodedPolyline({geometryType:"linestring"});o.addFeatures(new OpenLayers.Feature.Vector(n.read(get_track(t)).geometry.transform("EPSG:4326","EPSG:3857"))),e.addLayer(o)}}function add_waypoints(e){for(var t=0;t<get_amount_waypoints();t++){var o=new OpenLayers.Layer.Vector("wpt_"+t);o.projection=new OpenLayers.Projection("EPSG:4326");for(var n=new OpenLayers.Format.EncodedPolyline({geometryType:"multipoint"}).read(get_waypoints(t)).geometry.transform("EPSG:4326","EPSG:3857").getVertices(),a=0;a<n.length;a++){var r=new OpenLayers.Feature.Vector(n[a]);r.style={label:""+a,fontFamily:waypoint_font,fontSize:waypoint_font_size,fontColor:waypoint_font_color,labelOutlineWidth:waypoint_outline_width,labelOutlineColor:waypoint_outline_color},o.addFeatures(r)}e.addLayer(o)}}tileserver="/osm_tiles/${z}/${x}/${y}.png",page_border_color="red",page_border_width=2,track_color="green",track_width=5,track_opacity=.5,waypoint_font="Arial, Helvetica, sans-serif",waypoint_font_size=12,waypoint_font_color="black",waypoint_outline_width=1,waypoint_outline_color="white";var dragstart=null;function add_pages(t){for(var e=get_page_extents(),o=new OpenLayers.Layer.Boxes("Pages"),n=0;n<e.length;n++)bounds=OpenLayers.Bounds.fromArray(e[n]).transform("EPSG:4326","EPSG:900913"),page=new OpenLayers.Marker.Box(bounds),page.events.register("mousedown",page,function(e){return dragstart={x:e.screenX,y:e.screenY},t.events.handleBrowserEvent(e),!0}),page.events.register("mouseup",page,function(e){return dragstart&&(Math.abs(dragstart.x-e.screenX)<5||Math.abs(dragstart.y-e.screenY)<5)?(dragstart=null,show_page(this.bounds)):dragstart=null,t.events.handleBrowserEvent(e),!0}),page.setBorder(page_border_color,page_border_width),o.addMarker(page);t.addLayer(o)}function get_max_extent(){return new OpenLayers.Bounds(-20037508.342789244,-20037508.342789244,20037508.342789244,20037508.342789244)}function get_max_resolution(){return tile_size=256,project_ext=get_max_extent(),Math.min(Math.abs(project_ext.right-project_ext.left)/tile_size,Math.abs(project_ext.top-project_ext.bottom)/tile_size)}function get_optimal_zoom(e,t,o){for(viewport_width=document.getElementById(e).clientWidth,viewport_height=document.getElementById(e).clientHeight,max_res=get_max_resolution(),zoom=19;zoom-=1,res=max_res/Math.pow(2,zoom),0<zoom&&((o.lon-t.lon)/res>viewport_width||(o.lat-t.lat)/res>viewport_height););return zoom}function show_overview(e,t,o,n){var a={projection:new OpenLayers.Projection("EPSG:900913"),displayProjection:new OpenLayers.Projection("EPSG:4326"),units:"m",maxResolution:get_max_resolution(),maxExtent:get_max_extent(),numZoomLevels:20,controls:[new OpenLayers.Control.Navigation,new OpenLayers.Control.PanZoomBar,new OpenLayers.Control.Permalink,new OpenLayers.Control.ScaleLine,new OpenLayers.Control.MousePosition,new OpenLayers.Control.KeyboardDefaults,new OpenLayers.Control.Attribution]};map=new OpenLayers.Map("OverviewMap",a);var r=new OpenLayers.Layer.OSM("Default",tileserver,{numZoomLevels:19});map.addLayer(r),map.zoomIn(),add_tracks(map),add_pages(map);var s=new OpenLayers.LonLat((e+o)/2,(t+n)/2).transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject()),i=get_optimal_zoom("OverviewMap",new OpenLayers.LonLat(e,t).transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject()),new OpenLayers.LonLat(o,n).transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject()));map.setCenter(s,i)}function show_page(e){document.getElementById("DetailMap").style.display="block",document.getElementById("DetailMap").innerHTML='<div style="align=right"><a href="javascript:void(0)" onclick="close_page()">Close</a>',document.getElementById("fade").style.display="block";var t={projection:new OpenLayers.Projection("EPSG:900913"),displayProjection:new OpenLayers.Projection("EPSG:4326"),units:"m",maxResolution:get_max_resolution(),maxExtent:get_max_extent(),numZoomLevels:20,controls:[new OpenLayers.Control.MousePosition,new OpenLayers.Control.KeyboardDefaults]};map=new OpenLayers.Map("DetailMap",t);var o=new OpenLayers.Layer.OSM("Default",tileserver);map.addLayer(o),add_tracks(map),add_waypoints(map);var n=e.getCenterLonLat();map.setCenter(n,12)}function close_page(){document.getElementById("DetailMap").style.display="none",document.getElementById("fade").style.display="none"}